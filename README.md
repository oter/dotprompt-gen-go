# dotprompt-gen-go

A Go code generator that converts dotprompt files into type-safe Go input/output structs for AI applications.

## What it does

This tool parses `.prompt` files (used for AI prompt engineering) and generates Go structs from their YAML schema definitions. It's perfect for building type-safe AI applications where you need Go models that match your prompt schemas.

**Input**: `.prompt` files with YAML frontmatter containing schema definitions  
**Output**: Go files with type-safe structs, JSON tags, validation, and enum constants

## Installation

### Option 1: Direct Installation (Fastest)

Install globally for immediate use:

```bash
go install github.com/oter/dotprompt-gen-go/cmd/dotprompt-gen-go@latest

dotprompt-gen-go -file myfile.prompt
```

### Option 2: Go Tools (Go 1.24+)

Add as a project tool for version-locked, reproducible builds:

```bash
# Add tool to your project
go get -tool github.com/oter/dotprompt-gen-go/cmd/dotprompt-gen-go@latest

# Use the tool  
go tool dotprompt-gen-go -file myfile.prompt
```

This adds a `tool` entry to your `go.mod`:
```go
tool github.com/oter/dotprompt-gen-go
```

> **Note:** Go tools have some compilation overhead on each run. For frequent usage, direct installation is faster.

### Option 3: Direct Execution

Run without installation:

```bash
go run github.com/oter/dotprompt-gen-go/cmd/dotprompt-gen-go@latest [flags]
```

## Quick Start

Given a prompt file like `classify_habits.prompt`:

```yaml
---
model: openai/gpt-5-nano
input:
  schema:
    type: object
    properties:
      habit:
        type: string
        description: The habit to classify
    required:
      - habit
output:
  format: json
  schema:
    type: object
    properties:
      category:
        type: string
        enum: [physical_vitality, mental_mastery, social_connection]
        description: The category of the habit
      explanation:
        type: string
        description: Explanation of the classification
    required:
      - category
      - explanation
---
Classify this habit: {{habit}}
```

Generate Go structs:

```bash
dotprompt-gen-go -file classify_habits.prompt
```

**Output** (`classify_habits.gen.go`):

```go
// Code generated by prompt_codegen. DO NOT EDIT.

package models

// ClassifyHabitsInput represents the input for classify habits
type ClassifyHabitsInput struct {
	// The habit to classify
	Habit string `json:"habit" validate:"required"`
}

// ClassifyHabitsOutput represents the output for classify habits  
type ClassifyHabitsOutput struct {
	// The category of the habit
	Category CategoryEnum `json:"category" validate:"required"`
	// Explanation of the classification
	Explanation string `json:"explanation" validate:"required"`
}

// CategoryEnum represents valid category values
type CategoryEnum string

const (
	CategoryEnumPhysicalVitality CategoryEnum = "physical_vitality"
	CategoryEnumMentalMastery    CategoryEnum = "mental_mastery" 
	CategoryEnumSocialConnection CategoryEnum = "social_connection"
)
```

## Usage

### Single File

```bash
dotprompt-gen-go -file path/to/prompt.prompt
```

### Batch Processing

Process all `.prompt` files in a directory:

```bash
dotprompt-gen-go -dir path/to/prompts/
```

### Custom Package and Output

```bash
dotprompt-gen-go -dir ./prompts -pkg mymodels -out ./generated
```

### All Options

```
-file string    Single .prompt file to process
-dir string     Directory containing .prompt files  
-pkg string     Output package name (default "models")
-out string     Output directory (default: same as input)
-v              Verbose output
-h              Show help
```

## Supported Schema Formats

### JSON Schema (Recommended)

Standard JSON Schema with full support for:
- Basic types: `string`, `number`, `integer`, `boolean`
- Arrays with typed elements
- Enums with automatic constant generation
- Nested objects (generates nested structs)
- Required field validation

```yaml
input:
  schema:
    type: object
    properties:
      name:
        type: string
        description: User name
      age:
        type: integer
        description: User age
      tags:
        type: array
        items:
          type: string
      status:
        type: string
        enum: [active, inactive]
    required: [name, age]
```

### Picoschema (Simplified)

Lightweight schema format for simple cases:

```yaml
input:
  schema:
    name: string, the user name
    age: integer, user age  
    active?: boolean, whether user is active
    category(enum): [basic, premium], subscription level
    skills(array): string, list of skills
```

**Format**:
- `field: type, description` - required field
- `field?: type, description` - optional field  
- `field(enum): [val1, val2], description` - enum field
- `field(array): elementType, description` - array field

## Features

✅ **Type Safety** - Generates strongly-typed Go structs  
✅ **JSON Tags** - Automatic JSON serialization tags  
✅ **Validation** - Built-in validation tags for required fields  
✅ **Enums** - Generates enum types with constants  
✅ **Naming** - Converts snake_case to Go PascalCase  
✅ **Nested Objects** - Supports complex nested structures  
✅ **Arrays** - Handles typed arrays and slices  
✅ **Batch Processing** - Process entire directories  
✅ **Custom Output** - Control package names and output locations

## Integration

### With Taskfile

#### Using Direct Installation
Add to your `Taskfile.yml`:

```yaml
version: '3'

tasks:
  generate:
    desc: Generate Go models from prompt files
    cmds:
      - dotprompt-gen-go -dir ./prompts -pkg models -out ./internal/models

  build:
    desc: Generate models and build
    deps: [generate]
    cmds:
      - go build ./...
```

#### Using Go Tools (Go 1.24+)
```yaml
version: '3'

tasks:
  generate:
    desc: Generate Go models from prompt files
    cmds:
      - go tool dotprompt-gen-go -dir ./prompts -pkg models -out ./internal/models

  build:
    desc: Generate models and build
    deps: [generate]
    cmds:
      - go build ./...
```

Run with:
```bash
task generate
```

### With Make

#### Using Direct Installation
Add to your `Makefile`:

```makefile
.PHONY: generate
generate:
	dotprompt-gen-go -dir ./prompts -pkg models -out ./internal/models

build: generate
	go build ./...
```

#### Using Go Tools (Go 1.24+)
```makefile
.PHONY: generate
generate:
	go tool dotprompt-gen-go -dir ./prompts -pkg models -out ./internal/models

build: generate
	go build ./...
```

### With Go Generate

#### Using Direct Installation
Add to a `.go` file:

```go
//go:generate dotprompt-gen-go -dir ./prompts -pkg models
```

#### Using Go Tools (Go 1.24+)
First add the tool to your project, then use in generate:

```go
//go:generate go tool dotprompt-gen-go -dir ./prompts -pkg models
```

Then run:
```bash
go generate ./...
```

## Examples

See the `internal/test_prompts/` directory for comprehensive examples including:
- Basic JSON Schema types
- Complex nested objects  
- Array handling
- Enum definitions
- Mixed schema formats
- Picoschema syntax

## Requirements

- Go 1.24+
- Valid `.prompt` files with YAML frontmatter

## License

MIT License - see [LICENSE](LICENSE) for details.